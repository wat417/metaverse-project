# ğŸ“… æ—¥æ¬¡ä½œæ¥­è¨˜éŒ²ï¼ˆ2025/07/06ï¼‰

---

## âœ… æœ¬æ—¥ã®ä½œæ¥­ãƒ­ã‚°

| ã‚¹ãƒ†ãƒƒãƒ— | å†…å®¹ | å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ« |
|---------|------|--------------|
| Step16-a | å·®åˆ†æ¤œçŸ¥æ§‹é€ ã®æ•´å‚™ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‹å·®åˆ†é–¢æ•°ï¼‰ | `playerMap.ts` |
| Step16-b | ã‚¤ãƒ™ãƒ³ãƒˆé€šçŸ¥ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ–°è¦ä½œæˆ | `eventBus.ts` |
| Step16-c | RTDBå¤‰æ›´æ¤œçŸ¥ â†’ å·®åˆ†åˆ¤å®š â†’ ã‚¤ãƒ™ãƒ³ãƒˆé€šçŸ¥ã®æ§‹é€ å®Ÿè£… | `sync.ts`ï¼ˆ`listenPlayerData()`è¿½åŠ ï¼‰ |
| Step16-d | è¡¨ç¤ºæ›´æ–°ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç–çµåˆæ§‹ç¯‰ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡ â†’ UIåæ˜ ï¼‰ | `statusDisplay.ts`ï¼ˆæ–°è¦ä½œæˆï¼‰ |
| Step16-e | è¡¨ç¤ºç”Ÿæˆè²¬å‹™ã®å¤–éƒ¨å§”è­²ãƒ»ä¾å­˜æ’é™¤ï¼ˆMainSceneå†æ§‹æˆï¼‰ | `MainScene.ts`ï¼ˆè¨­è¨ˆæ§‹æˆæç¤ºï¼‰ |
| Step16-e-A | è¡¨ç¤ºæ§‹é€ ä¿®æ­£ã®å®Ÿè£…åæ˜ ï¼ˆstatusDisplay.tsã®å°å…¥ï¼‰ | `MainScene.ts`ï¼ˆä¿®æ­£å®Œäº†ï¼‰ |
| Step17-a | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºæ›´æ–°ã®ç²¾åº¦å‘ä¸Šï¼ˆå·®åˆ†æŠ½è±¡åŒ–ï¼‰ | `statusMap.ts`, `statusDisplay.ts` |
| Step17-b-S | name / emoji ã®éåŒæœŸåˆ¶å¾¡æ§‹é€ ã®è¨­è¨ˆæç¤º | `nameEmojiMap.ts`, `statusDisplay.ts` |
| Step17-c-S | RTDBä¸€æ‹¬å–å¾—æ§‹é€ ã¨è¡¨ç¤ºåæ˜ ã®è¨­è¨ˆæç¤º | `playerStateTracker.ts`, `sync.ts`, `statusDisplay.ts` |
| Step17-c-I | ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹ã®ä¸€æ‹¬åŒæœŸå®Ÿè£…ï¼ˆå–å¾— â†’ å·®åˆ†é€šçŸ¥ â†’ è¡¨ç¤ºåæ˜ ï¼‰ | `playerStateTracker.ts`, `sync.ts`, `statusDisplay.ts` |
| Step17-b-I-Resolve | è¡¨ç¤ºæ§‹é€ ã®æ•´åˆä¸å‚™ä¿®æ­£ï¼ˆcreateStatusLabel å¼•æ•°ä¿®æ­£ / syncPlayerPosition ä»•æ§˜å¾©å…ƒï¼‰ | `MainScene.ts`, `statusDisplay.ts`, `sync.ts` |

---

## ğŸ›  ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ï¼ˆä½œæ¥­ç€æ‰‹é †ï¼‰

1. `src/utils/playerStateTracker.ts`ï¼ˆæ–°è¦ï¼‰  
â€ƒâ€ƒè¿½åŠ ï¼š`playerStateCache`, `getDiffs()` ã«ã‚ˆã‚‹å·®åˆ†æ¤œçŸ¥æ§‹é€ 

2. `src/firebase/sync.ts`  
â€ƒâ€ƒè¿½åŠ ï¼š`syncAllPlayerStates()` ã«ã‚ˆã‚‹ RTDB ä¸€æ‹¬å–å¾—å‡¦ç†  
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒå·®åˆ†æŠ½å‡º â†’ `"playerBatchUpdate"` é€šçŸ¥ã‚¤ãƒ™ãƒ³ãƒˆã®ç™ºç«  
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒä¿®æ­£ï¼š`syncPlayerPosition(uid: string, x: number, y: number)` ã«ä»•æ§˜å¾©å…ƒ

3. `src/scenes/statusDisplay.ts`  
â€ƒâ€ƒè¿½åŠ ï¼š`on("playerBatchUpdate", â€¦)` ã«ã‚ˆã‚‹å·®åˆ†åæ˜ ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡  
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒ`hasStatusChanged()` / `hasNameOrEmojiChanged()` ã«ã‚ˆã‚‹æç”»åˆ¶å¾¡  
â€ƒâ€ƒä¿®æ­£ï¼š`createStatusLabel()` å¼•æ•°å½¢å¼ã®æ˜ç¤ºï¼ˆuid, name, emoji, statusï¼‰

4. `src/scenes/MainScene.ts`  
â€ƒâ€ƒä¿®æ­£ï¼š`createStatusLabel(this.uid, displayName, emoji, status)` ã«å¼•æ•°æ•´åˆ  
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒ`syncPlayerPosition(this.uid, x, y)` å‘¼ã³å‡ºã—å½¢å¼ã®ä»•æ§˜ç¢ºå®š  
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒ`displayName`, `emoji`, `status` ã‚’ `(window as any)` ã‹ã‚‰å–å¾—ã—ã¦æç”»åæ˜ 

---

## ğŸ¯ æ¬¡å›ä½œæ¥­äºˆå®š

- Step17-b-IIï¼šè¡¨ç¤ºãƒ©ãƒ™ãƒ«ã®å‹•çš„æ›´æ–°æ§‹é€ ã®è¨­è¨ˆï¼ˆ`updateStatusLabel()` æ¤œè¨ï¼‰  
- Step18ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ©ãƒ™ãƒ«ã‚’å€‹åˆ¥æç”»ã‹ã‚‰å‹•çš„ãƒªã‚¹ãƒˆåˆ¶å¾¡ã«å†è¨­è¨ˆã™ã‚‹æ§‹æƒ³

---

## ğŸ”’ é‹ç”¨ç•™æ„äº‹é …ï¼ˆè‡ªå‹•è£œå®Œï¼‰

- RTDB èª­ã¿å–ã‚Šå›æ•°ã®æœ€å°åŒ– â†’ è¡¨ç¤ºæ›´æ–°ã®åŠ¹ç‡æœ€é©åŒ–ã‚’é”æˆ  
- å·®åˆ†æ¤œçŸ¥ã¨è¡¨ç¤ºåæ˜ ã¯è²¬å‹™åˆ†é›¢ã•ã‚Œã¦ãŠã‚Šã€ä¿å®ˆæ€§ãŒå‘ä¸Š  
- name/emoji ã®å·®åˆ†æ§‹é€ ã¯ Step17-b-S æ®µéšã¾ã§è¨­è¨ˆæ¸ˆã€‚æ¬¡ã‚¹ãƒ†ãƒƒãƒ—ã§é€£æºæ•´å‚™äºˆå®š